
$(document).ready(function () {
    
    // Use event delegation to handle dynamically created elements
    $('#ncprTable tbody').on('click', '.add-btn', function () {
        var action = $(this).data("action");
        var role = $(this).data("role");

        var ncprNum = $(this).data('id'); // Get the ID from the clicked button

        // AJAX call to fetch full details
        $.ajax({
            url: 'fetch_dispo_details.php', // Your PHP file to fetch full data
            method: 'POST',
            data: {
                ncpr_num: ncprNum
            },
            dataType: 'json',
            success: function (response) {
                $('#view-id').text(response.id);
                $('#view-initiator').text(response.initiator);
                $('#view-ncpr-num').text(response.ncpr_num);
                $('#view-date').text(response.date);
                $('#view-part-number').text(response.part_number);
                $('#view-part-name').text(response.part_name);
                $('#view-process').text(response.process);
                $('#view-issue').text(response.issue);

                // Set checkbox values
                setCheckboxValue('#view-urgent-checkbox', response.urgent);
                setCheckboxValue('#repeating-yes', response.repeating);
                setCheckboxValue('#deviation-yes', response.deviation);
                setCheckboxValue('#view-mcs', response.mcs);
                setCheckboxValue('#view-customer_notif', response.customer_notif);
                setCheckboxValue('#view-fgparts', response.fgparts);
                setCheckboxValue('#view-wip', response.wip);
                setCheckboxValue('#view-one', response.one);
                setCheckboxValue('#view-one-one', response.one_one);
                setCheckboxValue('#view-two', response.two);
                setCheckboxValue('#view-three', response.three);
                setCheckboxValue('#view-four', response.four);
                setCheckboxValue('#view-five', response.five);
                setCheckboxValue('#view-six', response.six);
                setCheckboxValue('#view-eight', response.eight);
                setCheckboxValue('#view-nine', response.nine);

                // Handle radio buttons for recall, shipment, stop_proc, and seven
                setRadioButtonValue('view-recall', response.recall);
                setRadioButtonValue('view-shipment', response.shipment);
                setRadioButtonValue('view-stop_proc', response.stop_proc);
                setRadioButtonValue('view-seven', response.seven);

                // Handle text fields
                $('#view-awpi').text(response.awpi);
                $('#view-dc').text(response.dc);
                $('#view-cavity').text(response.cavity);
                $('#view-machine').text(response.machine);
                $('#view-ref').text(response.ref);
                $('#view-bg').text(response.bg);
                $('#view-mcs_details').text(response.mcs_details);
                $('#view-location').text(response.location);
                $('#view-ship_proc').text(response.ship_proc);
                $('#view-ship_sched').text(response.ship_sched);
                $('#view-two-one').text(response.two_one);
                $('#view-three-one').text(response.three_one);
                $('#view-seven-one').text(response.seven_one);
                $('#view-seven-two').text(response.seven_two);
                $('#view-eight-one').text(response.eight_one);
                $('#view-nine-one').text(response.nine_one);

                // Supplier details
                $('#view-supplier').text(response.supplier);
                $('#view-supplier-part-name').text(response.supplier_part_name);
                $('#view-supplier-part-number').text(response.supplier_part_number);
                $('#view-invoice-num').text(response.invoice_num);
                $('#view-purchase-order').text(response.purchase_order);

                // Show/hide supplier details
                if (
                    !response.supplier &&
                    !response.supplier_part_name &&
                    !response.supplier_part_number &&
                    !response.invoice_num &&
                    !response.purchase_order
                ) {
                    $('.supplier-details').hide();
                } else {
                    $('.supplier-details').show();
                }

                

                // Handle file attachments
                
            },
            error: function () {
                alert('Failed to fetch data.');
            }
        });
    });
});

// Function to set checkbox value
function setCheckboxValue(selector, value) {
    $(selector).prop("checked", value === "yes");
}

// Function to set radio button values
function setRadioButtonValue(name, value) {
    if (value === "yes") {
        $(`#${name}-yes`).prop("checked", true);
        $(`#${name}-no`).prop("checked", false);
    } else if (value === "no") {
        $(`#${name}-yes`).prop("checked", false);
        $(`#${name}-no`).prop("checked", true);
    } else {
        $(`#${name}-yes`).prop("checked", false);
        $(`#${name}-no`).prop("checked", false);
    }
}
$(document).ready(function () {
    
    $(".approval-action").click(function (e) {
        e.preventDefault();

        var action = $(this).data("action");
        var role = $(this).data("role");

        Swal.fire({
            title: "Are you sure?",
            text: "You are about to approve this action.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, approve it!",
            cancelButtonText: "Cancel"
        }).then((result) => {
            if (result.isConfirmed) {
                sendApprovalRequest(action, role); // Call function to process approval
            }
        });
    });

    function sendApprovalRequest(action, role) {
        let selectedId = $("#modal-id").text(); // Ensure selected ID is correctly retrieved

        var nonConformance = $("#non-conformance").val().trim();
        var correctiveAction = $("input[name='corrective_action']:checked").val();
        var causes = [];
        $("input[name='cause[]']:checked").each(function () {
            causes.push($(this).val());
        });

        var idNo = $("input[name='id_no']").val().trim();
        var name = $("input[name='name']").val().trim();

        var potentialFailure = $("input[name='potential_failure']:checked").val();
        var carChecked = $("input[name='car']").is(":checked") ? "CAR" : "";
        var carNo = $("input[name='car_no']").val().trim();
        var bdReport = $("input[name='bd_report']:checked").val();
        var scarChecked = $("input[name='scar']").is(":checked") ? "SCAR" : "";
        var scarNo = $("input[name='scar_no']").val().trim();

        var dispoFrom = [];
        $("input[name='dispo_from[]']:checked").each(function () {
            dispoFrom.push($(this).val());
        });

        var mrb = $("input[name='mrb']:checked").val();
        var customerApproval = $("input[name='customer_approval']:checked").val();
        var documentAlert = $("input[name='document_alert']").val().trim();
        var impactAnalysis = [];
        $("input[name='impact_analysis[]']:checked").each(function () {
            impactAnalysis.push($(this).val());
        });

        var impactAnalysisNotes = $("#impact_analysis").val().trim();
        var affectedBusiness = $("input[name='affected_business']").is(":checked") ? "Yes" : "No";
        var contactPerson = $("input[name='contact_person']").val().trim();
        var otherInstructions = $("input[name='other_instructions']").is(":checked") ? "Yes" : "No";
        var otherSpecify = $("input[name='other_specify']").val().trim();
        var productDispo = [];
        $("input[name='product_dispo[]']:checked").each(function () {
            productDispo.push($(this).val());
        });

        var yieldOff = $("input[name='yield_off']").val().trim();
        var daNo = $("input[name='da_no']").val().trim();
        var reworkDaNo = $("input[name='rework_da_no']").val().trim();
        var wisNo = $("input[name='wis_no']").val().trim();
        var scrapAmount = $("input[name='scrap_amount']").val().trim();
        var shipmentDate = $("input[name='shipment_date']").val().trim();

        console.log("Sending AJAX request...");
        $.ajax({
            url: "approval.php",
            type: "POST",
            data: {
                action: action,
                role: role,
                ncpr_num: selectedId,
                non_conformance: nonConformance,
                corrective_action: correctiveAction,
                causes: causes,
                id_no: idNo,
                name: name,
                potential_failure: potentialFailure,
                car: carChecked,
                car_no: carNo,
                bd_report: bdReport,
                scar: scarChecked,
                scar_no: scarNo,
                dispo_from: dispoFrom,
                mrb: mrb,
                customer_approval: customerApproval,
                document_alert: documentAlert,
                impact_analysis: impactAnalysis,
                impact_analysis_notes: impactAnalysisNotes,
                affected_business: affectedBusiness,
                contact_person: contactPerson,
                other_instructions: otherInstructions,
                other_specify: otherSpecify,
                product_dispo: productDispo,
                yield_off: yieldOff,
                da_no: daNo,
                rework_da_no: reworkDaNo,
                wis_no: wisNo,
                scrap_amount: scrapAmount,
                shipment_date: shipmentDate
            },
            success: function (response) {
                console.log("Raw response:", response);
                try {
                    var result = response; // No need for JSON.parse()
                    console.log("Parsed JSON:", result);

                    Swal.fire({
                        title: result.status === "success" ? "Success" : "Error",
                        text: result.message,
                        icon: result.status === "success" ? "success" : "error",
                        confirmButtonText: "OK"
                    }).then(() => {
                        if (result.status === "success") {
                            location.reload();
                        }
                    });

                } catch (e) {
                    console.error("Error parsing JSON response:", e, response);
                    Swal.fire("Error", "Unexpected server response. Check console.", "error");
                }
            },
        });
    }
});
